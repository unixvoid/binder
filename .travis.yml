language: go
sudo: required

go:
  - 1.7

services:
  - redis-server
  - docker

install:
  - make dependencies

script:
  - make stat

after_success:
  ### build and push to dockerhub
  - make clean docker
  - make clean build_travis_api_aci
  - docker login -e $DOCKER_EMAIL -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
  - docker tag unixvoid/binder unixvoid/binder:develop
  - docker push unixvoid/binder:develop
  ### push binary to binder
  - curl -i --form sec=$BINDER_SEC --form file=@`ls bin/binder*` --form path=binder/ https://cryo.unixvoid.com/upload
  - curl -i --form sec=$BINDER_SEC --form file=@`ls bin/binder*` --form filename=binder-latest-linux-amd64 --form path=binder/ https://cryo.unixvoid.com/upload
  ### build and push api aci
  - make clean build_travis_api_aci
  - mv binder-api.aci binder-api-latest-linux-amd64.aci
  # sign aci
  - cp deps/signapi.sh . && chmod +x signapi.sh
  - ./signapi.sh $GPG_SEC
  # upload binder aci image
  - curl -i --form sec=$BINDER_SEC --form file=@binder-api-latest-linux-amd64.aci --form path=rkt/binder/api/ https://cryo.unixvoid.com/upload
  - curl -i --form sec=$BINDER_SEC --form file=@binder-api-latest-linux-amd64.aci.asc --form path=rkt/binder/api/ https://cryo.unixvoid.com/upload
